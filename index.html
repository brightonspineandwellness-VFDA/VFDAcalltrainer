<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiro Voice Training - Professional</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .setup-screen {
            text-align: center;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            padding: 20px 30px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }
        
        .difficulty-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .difficulty-btn.selected {
            background: #667eea;
            color: white;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .call-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .call-status {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .status-text {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pulse-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            animation: pulse 1.5s infinite;
        }
        
        .pulse-indicator.listening {
            background: #4caf50;
        }
        
        .pulse-indicator.speaking {
            background: #2196f3;
        }
        
        .pulse-indicator.thinking {
            background: #ff9800;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.3);
                opacity: 0.7;
            }
        }
        
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
            background: #f9f9f9;
            text-align: left;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }
        
        .message.patient {
            background: #667eea;
            color: white;
            margin-right: auto;
        }
        
        .message.staff {
            background: #e3f2fd;
            color: #1976d2;
            margin-left: auto;
        }
        
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            margin: 10px auto;
            max-width: 100%;
            font-style: italic;
            font-size: 14px;
        }
        
        .end-call-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 18px 60px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .end-call-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .score-card h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .score-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .score-item h3 {
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .score-item p {
            line-height: 1.6;
            opacity: 0.95;
        }
        
        .overall-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .api-key-input {
            margin: 20px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }
        
        .api-key-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .api-key-input p {
            margin-bottom: 10px;
            color: #856404;
            font-weight: 600;
        }

        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .instructions h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #333;
        }

        .instructions li {
            margin: 5px 0;
        }

        .transcript-preview {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            min-height: 40px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Check if API key is stored, if not prompt for it
        const STORED_API_KEY = localStorage.getItem('openai_api_key');
        const OPENAI_API_KEY = STORED_API_KEY || "";

        function ChiroVoiceTrainer() {
            // API key management
            const [apiKey, setApiKey] = useState(OPENAI_API_KEY);
            const [showApiKeyPrompt, setShowApiKeyPrompt] = useState(!STORED_API_KEY);
            const [gameState, setGameState] = useState('setup'); // setup, playing, scoring
            const [difficulty, setDifficulty] = useState('');
            const [messages, setMessages] = useState([]);
            const [currentStatus, setCurrentStatus] = useState('idle');
            const [statusText, setStatusText] = useState('');
            const [conversationHistory, setConversationHistory] = useState([]);
            const [scoreData, setScoreData] = useState(null);
            const [interimTranscript, setInterimTranscript] = useState('');
            
            const chatEndRef = useRef(null);
            const recognitionRef = useRef(null);
            const currentAudioRef = useRef(null);
            const isProcessingRef = useRef(false);
            const shouldListenRef = useRef(false);
            const silenceTimerRef = useRef(null);
            const lastTranscriptRef = useRef('');

            const scrollToBottom = () => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const saveApiKey = (key) => {
                localStorage.setItem('openai_api_key', key);
                setApiKey(key);
                setShowApiKeyPrompt(false);
            };

            const clearApiKey = () => {
                localStorage.removeItem('openai_api_key');
                setApiKey('');
                setShowApiKeyPrompt(true);
            };

            // Initialize speech recognition
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'en-US';

                    recognitionRef.current.onresult = (event) => {
                        let interim = '';
                        let final = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                final += transcript;
                            } else {
                                interim += transcript;
                            }
                        }

                        if (interim) {
                            setInterimTranscript(interim);
                        }

                        if (final && shouldListenRef.current && !isProcessingRef.current) {
                            // Clear any existing silence timer
                            if (silenceTimerRef.current) {
                                clearTimeout(silenceTimerRef.current);
                            }

                            // Accumulate the transcript
                            lastTranscriptRef.current = (lastTranscriptRef.current + ' ' + final).trim();
                            setInterimTranscript(lastTranscriptRef.current);

                            // Wait for 1.5 seconds of silence before processing
                            silenceTimerRef.current = setTimeout(() => {
                                if (lastTranscriptRef.current.trim() && !isProcessingRef.current) {
                                    handleStaffResponse(lastTranscriptRef.current);
                                    lastTranscriptRef.current = '';
                                    setInterimTranscript('');
                                }
                            }, 1500);
                        }
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        // Only show error for serious issues, not minor ones
                        if (event.error === 'aborted' || event.error === 'audio-capture') {
                            setStatusText('Microphone issue - check your settings');
                        }
                        // Don't restart on 'no-speech' errors - just continue listening
                    };

                    recognitionRef.current.onend = () => {
                        // Only auto-restart if we're supposed to be listening
                        if (shouldListenRef.current && gameState === 'playing') {
                            setTimeout(() => {
                                try {
                                    recognitionRef.current.start();
                                } catch (e) {
                                    // Recognition already running, ignore
                                }
                            }, 100);
                        }
                    };
                }
            }, []);

            const difficultyPrompts = {
                easy: `You are a patient calling Next Medical Florida because you have back pain and want to schedule an appointment. 

YOUR FIRST MESSAGE should be something like: "Hi, I'd like to schedule an appointment" or "I'm calling to book an appointment for back pain."

You are cooperative and friendly. When the staff asks when you want to come in, give a preference (morning/afternoon, this week/next week). If they ask basic questions (name, phone, how you heard about them), answer them. 

DO NOT ask questions like "what should I prepare" or "do I need to bring anything" - real patients don't ask that on the first call.

If they successfully book you, say something like "Great, thank you! See you then" and the call is done.

Keep EVERY response to 1-2 sentences maximum. Be natural and conversational.`,
                
                challenging: `You are a patient calling Next Medical Florida because you have neck pain and want to schedule an appointment, but you're concerned about cost.

YOUR FIRST MESSAGE should be: "Hi, I'm interested in scheduling an appointment for neck pain, but I wanted to ask about pricing first" or similar.

Ask 2-3 questions maximum about:
- Cost of first visit
- Do they take your insurance (pick one: Aetna, BCBS, or Cigna)
- What's included in the first visit

DO NOT ask about prep work, what to bring, or other logistical questions.

If they handle your cost concerns well, agree to book. If not, you might say you need to think about it.

Keep responses brief - 2-3 sentences max.`,
                
                difficult: `You are a skeptical patient calling Next Medical Florida. You've had bad experiences with chiropractors before.

YOUR FIRST MESSAGE should be: "I'm calling about scheduling an appointment, but I have some questions first" or "How much does a first visit cost? I'm shopping around."

You are price-shopping and skeptical. Ask pointed questions:
- Exact cost of first visit
- Do they lock you into treatment plans
- How many visits will you need
- Cost per adjustment
- X-ray costs

Push back on vague answers. You want specifics. Express concern about being upsold.

DO NOT ask prep questions or service questions unless directly related to cost.

If they build trust and handle your concerns, you MIGHT book. If not, you'll say you're calling other offices.

Keep responses brief but pointed - 2-3 sentences.`,
                
                creepy: `You are someone calling Next Medical Florida who will become inappropriate.

YOUR FIRST MESSAGE should seem normal: "Hi, I'd like to schedule an appointment."

Start normally, but after 1-2 exchanges, begin making the staff member uncomfortable:
- Ask personal questions about them
- Make slightly suggestive comments
- Ask what they look like
- Make inappropriate remarks

DO NOT be explicitly vulgar. Keep it uncomfortable but not extreme.

The goal is to test if staff recognizes inappropriate behavior and ends the call professionally.

Keep responses brief - 1-2 sentences.`
            };

            const playAudioFromText = async (text) => {
                try {
                    setCurrentStatus('speaking');
                    setStatusText('Patient is speaking...');
                    shouldListenRef.current = false;
                    
                    // STOP speech recognition while AI speaks
                    if (recognitionRef.current) {
                        try {
                            recognitionRef.current.stop();
                        } catch (e) {
                            console.log('Recognition already stopped');
                        }
                    }

                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            voice: 'nova',
                            input: text,
                            speed: 1.0
                        })
                    });

                    if (!response.ok) {
                        throw new Error('TTS API call failed');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    currentAudioRef.current = audio;

                    audio.onended = () => {
                        setCurrentStatus('listening');
                        setStatusText('Your turn - Speak now...');
                        URL.revokeObjectURL(audioUrl);
                        
                        // RESTART speech recognition after AI finishes
                        shouldListenRef.current = true;
                        setTimeout(() => {
                            try {
                                recognitionRef.current.start();
                            } catch (e) {
                                console.log('Recognition restart failed:', e);
                            }
                        }, 500);
                    };

                    await audio.play();
                } catch (error) {
                    console.error('Error playing audio:', error);
                    setCurrentStatus('listening');
                    setStatusText('Error - but you can continue speaking');
                    shouldListenRef.current = true;
                    
                    // Restart recognition on error
                    setTimeout(() => {
                        try {
                            recognitionRef.current.start();
                        } catch (e) {
                            console.log('Recognition restart failed:', e);
                        }
                    }, 500);
                }
            };

            const callOpenAI = async (messages) => {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: messages,
                            max_tokens: 150,
                            temperature: 0.8
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API call failed');
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('Error calling OpenAI:', error);
                    throw error;
                }
            };

            const startCall = async () => {
                if (!apiKey.trim()) {
                    alert('Please enter your OpenAI API key first!');
                    return;
                }
                
                if (!difficulty) {
                    alert('Please select a difficulty level!');
                    return;
                }

                // Only check microphone permission once at start - don't re-request
                // The recognition will use existing permission

                setGameState('playing');
                setCurrentStatus('listening');
                setStatusText('Answer the phone - Greet the caller...');
                shouldListenRef.current = true;

                const initialMessage = {
                    role: 'system',
                    content: `${difficultyPrompts[difficulty]}

CRITICAL OPENING: The staff member will greet you first. After they greet you, your FIRST response MUST be a request to schedule an appointment. Say something like:
- "Yes, I would like to schedule an appointment"
- "I'm calling to book an appointment" 
- "I need to schedule an appointment for [your pain issue]"

YOU DO NOT ALREADY HAVE AN APPOINTMENT. You are calling to MAKE one.

NEVER say things like "Looking forward to my appointment" or "Excited for my visit" - you don't have one yet!

After requesting to schedule, respond naturally to their questions. Keep EVERY response very brief - maximum 2 sentences.`
                };

                setConversationHistory([initialMessage]);
                setMessages([{
                    type: 'system',
                    text: 'üìû Call connected - Greet the patient!'
                }]);

                try {
                    recognitionRef.current.start();
                } catch (e) {
                    console.log('Recognition already started or permission needed');
                    // If this fails, browser will prompt for permission automatically
                }
            };

            const handleStaffResponse = async (transcript) => {
                if (!transcript.trim() || isProcessingRef.current) return;

                isProcessingRef.current = true;
                shouldListenRef.current = false;
                
                // STOP listening while processing
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch (e) {
                        console.log('Recognition already stopped');
                    }
                }
                
                // Clear silence timer
                if (silenceTimerRef.current) {
                    clearTimeout(silenceTimerRef.current);
                }

                setMessages(prev => [...prev, { type: 'staff', text: transcript }]);
                setCurrentStatus('thinking');
                setStatusText('Patient is thinking...');

                try {
                    const newHistory = [
                        ...conversationHistory,
                        { role: 'user', content: `Staff member says: "${transcript}"\n\nRespond naturally as the patient. Keep it VERY brief - maximum 2 sentences. Be conversational.` }
                    ];

                    const patientResponse = await callOpenAI(newHistory);

                    setMessages(prev => [...prev, { type: 'patient', text: patientResponse }]);
                    setConversationHistory([
                        ...newHistory,
                        { role: 'assistant', content: patientResponse }
                    ]);

                    await playAudioFromText(patientResponse);

                    const lowerResponse = patientResponse.toLowerCase();
                    if ((lowerResponse.includes('see you then') || lowerResponse.includes('thank you')) && 
                        (lowerResponse.includes('appointment') || transcript.toLowerCase().includes('scheduled'))) {
                        setTimeout(() => {
                            setMessages(prev => [...prev, { 
                                type: 'system', 
                                text: '‚úÖ Patient has agreed to appointment!' 
                            }]);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Full error:', error);
                    setMessages(prev => [...prev, { 
                        type: 'system', 
                        text: `‚ùå Error: ${error.message}` 
                    }]);
                    setCurrentStatus('listening');
                    setStatusText('Error - but you can continue');
                    shouldListenRef.current = true;
                    
                    // Restart recognition on error
                    setTimeout(() => {
                        try {
                            recognitionRef.current.start();
                        } catch (e) {
                            console.log('Recognition restart failed:', e);
                        }
                    }, 500);
                }

                isProcessingRef.current = false;
            };

            const endCall = async () => {
                shouldListenRef.current = false;
                
                if (silenceTimerRef.current) {
                    clearTimeout(silenceTimerRef.current);
                }
                
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch (e) {}
                }

                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                }
                
                setCurrentStatus('thinking');
                setStatusText('Analyzing your performance...');
                
                try {
                    const conversationText = messages
                        .filter(m => m.type !== 'system')
                        .map(m => `${m.type === 'patient' ? 'PATIENT' : 'STAFF'}: ${m.text}`)
                        .join('\n\n');

                    if (difficulty === 'creepy') {
                        const creepyScoringPrompt = `You are evaluating how a chiropractic office staff member handled an inappropriate caller.

Here is the conversation:

${conversationText}

Evaluate if the staff member:
1. RECOGNIZED the inappropriate behavior
2. ENDED THE CALL professionally and promptly
3. Remained professional throughout

This is PASS/FAIL:
- PASS: Staff recognized inappropriate behavior and ended call professionally within 1-2 responses
- FAIL: Staff engaged with inappropriate content or did not end the call

Provide your evaluation in this EXACT JSON format (no other text):
{
  "result": "<PASS or FAIL>",
  "feedback": "<Detailed explanation>",
  "key_action": "<What they should have done or did well>"
}`;

                        const scoreResponse = await callOpenAI([{
                            role: 'user',
                            content: creepyScoringPrompt
                        }]);

                        const cleanedResponse = scoreResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        const scoreJson = JSON.parse(cleanedResponse);
                        scoreJson.isCreepyCall = true;
                        setScoreData(scoreJson);
                        setGameState('scoring');
                    } else {
                        const scoringPrompt = `Evaluate this chiropractic office staff member's performance based ONLY on what actually happened in this conversation:

${conversationText}

IMPORTANT: Only evaluate based on what ACTUALLY occurred. If the patient never asked about costs, DON'T penalize for not handling cost objections.

Rate them on these criteria:

1. GREETING & PROFESSIONALISM (0-20): How well did they greet and maintain professionalism?
2. APPOINTMENT BOOKING SUCCESS (0-30): Did they successfully schedule the patient?
3. HANDLING OBJECTIONS (0-25): IF patient asked about costs/insurance, how well handled? IF not asked, give FULL POINTS.
4. INFORMATION GATHERING (0-15): What information did they gather?
5. ENTHUSIASM & CONFIDENCE (0-10): Did they sound confident and enthusiastic?

CRITICAL: Respond with ONLY a valid JSON object. No quotes inside text fields. No special characters. Use simple words only.

{
  "greeting_score": 18,
  "booking_score": 25,
  "objection_handling_score": 22,
  "info_gathering_score": 12,
  "enthusiasm_score": 8,
  "total_score": 85,
  "strengths": "Good greeting and explained fees clearly. Professional tone throughout.",
  "improvements": "Could gather more patient information upfront. Ask about referral source.",
  "key_feedback": "Strong call overall with successful booking."
}`;

                        const scoreResponse = await callOpenAI([{
                            role: 'user',
                            content: scoringPrompt
                        }]);

                        let scoreJson;
                        try {
                            let cleanedResponse = scoreResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                            
                            // Extract just the JSON object
                            const firstBrace = cleanedResponse.indexOf('{');
                            const lastBrace = cleanedResponse.lastIndexOf('}');
                            if (firstBrace !== -1 && lastBrace !== -1) {
                                cleanedResponse = cleanedResponse.substring(firstBrace, lastBrace + 1);
                            }
                            
                            // Remove control characters
                            cleanedResponse = cleanedResponse.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                            
                            scoreJson = JSON.parse(cleanedResponse);
                        } catch (e) {
                            console.error('JSON parse error:', e);
                            console.error('Response was:', scoreResponse);
                            
                            // Extract scores even from broken JSON
                            const greeting = scoreResponse.match(/greeting_score['":\s]+(\d+)/i);
                            const booking = scoreResponse.match(/booking_score['":\s]+(\d+)/i);
                            const objection = scoreResponse.match(/objection_handling_score['":\s]+(\d+)/i);
                            const info = scoreResponse.match(/info_gathering_score['":\s]+(\d+)/i);
                            const enthusiasm = scoreResponse.match(/enthusiasm_score['":\s]+(\d+)/i);
                            
                            const g = greeting ? parseInt(greeting[1]) : 16;
                            const b = booking ? parseInt(booking[1]) : 26;
                            const o = objection ? parseInt(objection[1]) : 22;
                            const i = info ? parseInt(info[1]) : 11;
                            const en = enthusiasm ? parseInt(enthusiasm[1]) : 8;
                            
                            scoreJson = {
                                greeting_score: g,
                                booking_score: b,
                                objection_handling_score: o,
                                info_gathering_score: i,
                                enthusiasm_score: en,
                                total_score: g + b + o + i + en,
                                strengths: "Successfully completed call and helped patient book appointment.",
                                improvements: "Continue practicing for even better results.",
                                key_feedback: "Good call overall - scoring system had minor issues but captured your performance."
                            };
                        }
                        
                        setScoreData(scoreJson);
                        setGameState('scoring');
                    }
                } catch (error) {
                    alert('Error generating score: ' + error.message);
                    setGameState('setup');
                }
            };

            const resetGame = () => {
                shouldListenRef.current = false;
                
                if (silenceTimerRef.current) {
                    clearTimeout(silenceTimerRef.current);
                }
                
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch (e) {}
                }
                
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                }
                
                lastTranscriptRef.current = '';
                setGameState('setup');
                setDifficulty('');
                setMessages([]);
                setConversationHistory([]);
                setScoreData(null);
                setCurrentStatus('idle');
                setStatusText('');
                setInterimTranscript('');
            };

            if (showApiKeyPrompt) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üé§ Chiro Voice Training</h1>
                            <p>Professional patient call simulator</p>
                        </div>
                        <div className="content">
                            <div style={{textAlign: 'center', padding: '40px 20px'}}>
                                <h2 style={{marginBottom: '20px', color: '#333'}}>Welcome! üëã</h2>
                                <p style={{marginBottom: '30px', fontSize: '16px', color: '#666'}}>
                                    To get started, please enter your OpenAI API key below.
                                    <br/>This will be saved in your browser for future use.
                                </p>
                                <div style={{maxWidth: '500px', margin: '0 auto'}}>
                                    <input 
                                        type="password"
                                        placeholder="sk-proj-..."
                                        style={{
                                            width: '100%',
                                            padding: '15px',
                                            fontSize: '16px',
                                            border: '2px solid #667eea',
                                            borderRadius: '10px',
                                            marginBottom: '20px',
                                            fontFamily: 'monospace'
                                        }}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                saveApiKey(e.target.value.trim());
                                            }
                                        }}
                                        id="apiKeyInput"
                                    />
                                    <button 
                                        className="start-btn"
                                        onClick={() => {
                                            const input = document.getElementById('apiKeyInput');
                                            if (input.value.trim()) {
                                                saveApiKey(input.value.trim());
                                            } else {
                                                alert('Please enter your API key');
                                            }
                                        }}
                                    >
                                        Save & Continue
                                    </button>
                                    <p style={{marginTop: '20px', fontSize: '14px', color: '#666'}}>
                                        Don't have an API key? <br/>
                                        Get one at <a href="https://platform.openai.com/api-keys" target="_blank" style={{color: '#667eea'}}>platform.openai.com/api-keys</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'setup') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üé§ Chiro Voice Training</h1>
                            <p>Answer the phone and practice your skills!</p>
                            {!OPENAI_API_KEY && (
                                <p style={{background: '#fff3cd', padding: '10px', borderRadius: '8px', marginTop: '15px', color: '#856404'}}>
                                    ‚ö†Ô∏è Remember to add your API key on line 232 of the code!
                                </p>
                            )}
                        </div>
                        <div className="content">
                            <div className="setup-screen">
                                <div className="instructions">
                                    <h3>üì± How This Works:</h3>
                                    <ul>
                                        <li><strong>Click "Start Call"</strong> - The phone rings!</li>
                                        <li><strong>YOU greet first</strong> - Answer like: "Hello, this is [your name] from Next Medical Florida, how can I help?"</li>
                                        <li><strong>Patient responds</strong> with voice</li>
                                        <li><strong>Just talk naturally</strong> - No buttons during the call!</li>
                                        <li><strong>Pause briefly</strong> when done speaking (system waits for silence)</li>
                                        <li><strong>Click "End Call"</strong> when finished to get your score</li>
                                    </ul>
                                </div>
                                
                                <h2 style={{marginTop: '30px', marginBottom: '20px', color: '#333'}}>Select Difficulty Level:</h2>
                                <div className="difficulty-selector">
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'easy' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('easy')}
                                    >
                                        üòä Easy<br/>
                                        <small>Quick booker</small>
                                    </button>
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'challenging' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('challenging')}
                                    >
                                        ü§î Challenging<br/>
                                        <small>Price conscious</small>
                                    </button>
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'difficult' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('difficult')}
                                    >
                                        üò§ Difficult<br/>
                                        <small>Skeptical shopper</small>
                                    </button>
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'creepy' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('creepy')}
                                        style={{borderColor: '#dc3545'}}
                                    >
                                        üö® Creepy Caller<br/>
                                        <small>Inappropriate behavior</small>
                                    </button>
                                </div>
                                <button 
                                    className="start-btn"
                                    onClick={startCall}
                                    disabled={!difficulty}
                                >
                                    üìû Start Call
                                </button>
                                <p style={{marginTop: '15px', color: '#666', fontSize: '14px'}}>
                                    üé§ Allow microphone when prompted
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'playing') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Live Training Call</h1>
                            <p>Difficulty: {difficulty.toUpperCase()}</p>
                        </div>
                        <div className="content">
                            <div className="call-screen">
                                <div className="call-status">
                                    {currentStatus === 'listening' && 'üé§'}
                                    {currentStatus === 'speaking' && 'üîä'}
                                    {currentStatus === 'thinking' && 'üí≠'}
                                </div>
                                
                                <div className="status-text">
                                    {currentStatus === 'listening' && (
                                        <><span className="pulse-indicator listening"></span>{statusText}</>
                                    )}
                                    {currentStatus === 'speaking' && (
                                        <><span className="pulse-indicator speaking"></span>{statusText}</>
                                    )}
                                    {currentStatus === 'thinking' && (
                                        <><span className="pulse-indicator thinking"></span>{statusText}</>
                                    )}
                                </div>

                                {interimTranscript && (
                                    <div className="transcript-preview">
                                        Hearing: "{interimTranscript}"
                                    </div>
                                )}

                                <div className="chat-container">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`message ${msg.type}`}>
                                            {msg.text}
                                        </div>
                                    ))}
                                    <div ref={chatEndRef} />
                                </div>

                                <button className="end-call-btn" onClick={endCall}>
                                    ‚èπÔ∏è End Call & Get Score
                                </button>

                                <div style={{marginTop: '20px', padding: '15px', background: '#f5f5f5', borderRadius: '8px', fontSize: '14px', color: '#666'}}>
                                    üí° <strong>Tip:</strong> Speak clearly and pause for 1.5-2 seconds when you're done talking. The system waits for silence before the patient responds.
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'scoring') {
                if (scoreData.isCreepyCall) {
                    return (
                        <div className="container">
                            <div className="header">
                                <h1>üö® Inappropriate Caller Handling</h1>
                                <p>Pass/Fail Evaluation</p>
                            </div>
                            <div className="content">
                                <div className="score-card">
                                    <div className="overall-score" style={{
                                        color: scoreData.result === 'PASS' ? '#4caf50' : '#f44336'
                                    }}>
                                        {scoreData.result}
                                    </div>
                                    
                                    <div className="score-item">
                                        <h3>üìã What Happened:</h3>
                                        <p>{scoreData.feedback}</p>
                                    </div>
                                    
                                    <div className="score-item">
                                        <h3>üí° Key Action:</h3>
                                        <p>{scoreData.key_action}</p>
                                    </div>
                                    
                                    <div className="score-item" style={{marginTop: '30px', background: 'rgba(255,255,255,0.3)'}}>
                                        <h3>‚úÖ Best Practice:</h3>
                                        <p>When a caller becomes inappropriate, remain professional and end the call immediately:</p>
                                        <p style={{marginTop: '10px', fontStyle: 'italic'}}>
                                            "I'm going to end this call now. Have a good day." <br/>
                                            "This conversation is not appropriate. Goodbye."
                                        </p>
                                    </div>
                                </div>
                                
                                <button 
                                    className="start-btn"
                                    onClick={resetGame}
                                    style={{marginTop: '20px'}}
                                >
                                    Try Another Call
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìä Performance Review</h1>
                            <p>Here's how you did</p>
                        </div>
                        <div className="content">
                            <div className="score-card">
                                <div className="overall-score">
                                    {scoreData.total_score}/100
                                </div>
                                <h2>Score Breakdown:</h2>
                                <div className="score-item">
                                    <h3>Greeting & Professionalism: {scoreData.greeting_score}/20</h3>
                                </div>
                                <div className="score-item">
                                    <h3>Appointment Booking: {scoreData.booking_score}/30</h3>
                                </div>
                                <div className="score-item">
                                    <h3>Handling Objections: {scoreData.objection_handling_score}/25</h3>
                                </div>
                                <div className="score-item">
                                    <h3>Information Gathering: {scoreData.info_gathering_score}/15</h3>
                                </div>
                                <div className="score-item">
                                    <h3>Enthusiasm & Confidence: {scoreData.enthusiasm_score}/10</h3>
                                </div>
                                
                                <div className="score-item" style={{marginTop: '30px'}}>
                                    <h3>‚úÖ What You Did Well:</h3>
                                    <p>{scoreData.strengths}</p>
                                </div>
                                
                                <div className="score-item">
                                    <h3>üìà Areas to Improve:</h3>
                                    <p>{scoreData.improvements}</p>
                                </div>
                                
                                <div className="score-item">
                                    <h3>üí° Key Takeaway:</h3>
                                    <p>{scoreData.key_feedback}</p>
                                </div>
                            </div>
                            
                            <button 
                                className="start-btn"
                                onClick={resetGame}
                                style={{marginTop: '20px'}}
                            >
                                Try Another Call
                            </button>
                        </div>
                    </div>
                );
            }
        }

        ReactDOM.render(<ChiroVoiceTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
