<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiro Voice Training - Professional</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .setup-screen {
            text-align: center;
        }
        
        .difficulty-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            padding: 20px 30px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }
        
        .difficulty-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .difficulty-btn.selected {
            background: #667eea;
            color: white;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .call-screen {
            text-align: center;
            padding: 40px 20px;
        }
        
        .call-status {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .status-text {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pulse-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 15px;
            animation: pulse 1.5s infinite;
        }
        
        .pulse-indicator.listening {
            background: #4caf50;
        }
        
        .pulse-indicator.speaking {
            background: #2196f3;
        }
        
        .pulse-indicator.thinking {
            background: #ff9800;
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.3);
                opacity: 0.7;
            }
        }
        
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
            background: #f9f9f9;
            text-align: left;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }
        
        .message.patient {
            background: #667eea;
            color: white;
            margin-right: auto;
        }
        
        .message.staff {
            background: #e3f2fd;
            color: #1976d2;
            margin-left: auto;
        }
        
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            margin: 10px auto;
            max-width: 100%;
            font-style: italic;
            font-size: 14px;
        }
        
        .end-call-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 18px 60px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .end-call-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .score-card h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .score-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .score-item h3 {
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .score-item p {
            line-height: 1.6;
            opacity: 0.95;
        }
        
        .overall-score {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        
        .api-key-input {
            margin: 20px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }
        
        .api-key-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .api-key-input p {
            margin-bottom: 10px;
            color: #856404;
            font-weight: 600;
        }

        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .instructions h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-left: 20px;
            color: #333;
        }

        .instructions li {
            margin: 5px 0;
        }

        .transcript-preview {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            min-height: 40px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Check if API key is stored, if not prompt for it
        const STORED_API_KEY = localStorage.getItem('openai_api_key');
        const OPENAI_API_KEY = STORED_API_KEY || "";

        // Password protection - CHANGE THIS PASSWORD!
        const APP_PASSWORD = "ChiroTrain2025"; // ‚Üê CHANGE THIS to your own password!
        
        function ChiroVoiceTrainer() {
            // API key management
            const [apiKey, setApiKey] = useState(OPENAI_API_KEY);
            const [showApiKeyPrompt, setShowApiKeyPrompt] = useState(!STORED_API_KEY);
            const [isAuthenticated, setIsAuthenticated] = useState(
                sessionStorage.getItem('app_authenticated') === 'true'
            );
            const [passwordAttempt, setPasswordAttempt] = useState('');
            const [passwordError, setPasswordError] = useState('');
            const [gameState, setGameState] = useState('setup'); // setup, playing, scoring
            const [difficulty, setDifficulty] = useState('');
            const [messages, setMessages] = useState([]);
            const [currentStatus, setCurrentStatus] = useState('idle');
            const [statusText, setStatusText] = useState('');
            const [conversationHistory, setConversationHistory] = useState([]);
            const [scoreData, setScoreData] = useState(null);
            const [interimTranscript, setInterimTranscript] = useState('');
            
            const chatEndRef = useRef(null);
            const recognitionRef = useRef(null);
            const currentAudioRef = useRef(null);
            const isProcessingRef = useRef(false);
            const shouldListenRef = useRef(false);
            const silenceTimerRef = useRef(null);
            const lastTranscriptRef = useRef('');

            const scrollToBottom = () => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const saveApiKey = (key) => {
                localStorage.setItem('openai_api_key', key);
                setApiKey(key);
                setShowApiKeyPrompt(false);
            };

            const clearApiKey = () => {
                localStorage.removeItem('openai_api_key');
                setApiKey('');
                setShowApiKeyPrompt(true);
            };

            const checkPassword = () => {
                if (passwordAttempt === APP_PASSWORD) {
                    sessionStorage.setItem('app_authenticated', 'true');
                    setIsAuthenticated(true);
                    setPasswordError('');
                } else {
                    setPasswordError('Incorrect password. Please try again.');
                    setPasswordAttempt('');
                }
            };

            // Initialize speech recognition
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'en-US';

                    recognitionRef.current.onresult = (event) => {
                        let interim = '';
                        let final = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                final += transcript;
                            } else {
                                interim += transcript;
                            }
                        }

                        if (interim) {
                            setInterimTranscript(interim);
                        }

                        if (final && shouldListenRef.current && !isProcessingRef.current) {
                            // Clear any existing silence timer
                            if (silenceTimerRef.current) {
                                clearTimeout(silenceTimerRef.current);
                            }

                            // Accumulate the transcript
                            lastTranscriptRef.current = (lastTranscriptRef.current + ' ' + final).trim();
                            setInterimTranscript(lastTranscriptRef.current);

                            // Wait for 1.5 seconds of silence before processing
                            silenceTimerRef.current = setTimeout(() => {
                                if (lastTranscriptRef.current.trim() && !isProcessingRef.current) {
                                    handleStaffResponse(lastTranscriptRef.current);
                                    lastTranscriptRef.current = '';
                                    setInterimTranscript('');
                                }
                            }, 1500);
                        }
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        // Only show error for serious issues, not minor ones
                        if (event.error === 'aborted' || event.error === 'audio-capture') {
                            setStatusText('Microphone issue - check your settings');
                        }
                        // Don't restart on 'no-speech' errors - just continue listening
                    };

                    recognitionRef.current.onend = () => {
                        // Only auto-restart if we're supposed to be listening
                        if (shouldListenRef.current && gameState === 'playing') {
                            setTimeout(() => {
                                try {
                                    recognitionRef.current.start();
                                } catch (e) {
                                    // Recognition already running, ignore
                                }
                            }, 100);
                        }
                    };
                }
            }, []);

            const difficultyPrompts = {
                easy: `You are a patient calling a chiropractic office because you have back pain and want to schedule an appointment. 

YOUR FIRST MESSAGE must be a simple booking request like: "Hi, I'd like to schedule an appointment" or "I'm calling to book an appointment for back pain."

CRITICAL: DO NOT ask about services, treatments, what to expect, or what they offer. Just say you want to book.

After staff responds, you cooperate with their questions. Answer when they ask about:
- Your availability (say morning or afternoon, this week or next)
- Your name (give a simple name like John or Maria)
- Your phone number (give a fake number like 555-1234)
- Your email (give fake like john@email.com)
- Health concerns (say back pain or neck pain)
- How you heard about them (say "a friend" or "Google")

DO NOT ask ANY questions. You are cooperative and simple. If staff explains cost and appointment time, say "Sounds good, thank you!" and STOP.

Keep EVERY response to ONLY 1 sentence. Be brief.

When appointment is confirmed and all info is collected, say "Great, see you then" and the conversation is DONE.`,
                
                challenging: `You are a price-conscious patient calling a chiropractic office. You want to schedule but need to understand costs first.

YOUR FIRST MESSAGE: "Hi, I'm interested in scheduling an appointment, but I wanted to ask about the cost of the first visit" or "I'd like to book an appointment but what do you charge?"

After they answer your cost question, you may ask 1-2 follow-up questions like:
- Do you take my insurance? (say Aetna or BCBS)
- What's included in the first visit?

If they explain things well, agree to book. Answer their scheduling questions cooperatively.

DO NOT ask about what to bring or expect unless they never mention it.

Keep responses 2-3 sentences max. If satisfied with answers, book the appointment.`,
                
                difficult: `You are a skeptical patient who has had bad experiences. You want to schedule but have concerns.

YOUR FIRST MESSAGE: "I'm calling about scheduling an appointment, but I've had bad experiences before so I have some questions" or "I'd like to book but how much does this cost? I'm shopping around."

You ask pointed questions:
- Exact first visit cost
- Do they lock you into treatment plans
- How many visits will you need
- Hidden costs or x-ray fees

Push back if answers are vague. Want specific numbers and guarantees.

DO NOT ask logistical questions like what to bring unless it relates to cost.

If staff builds trust and gives clear answers, you MIGHT book. If they're dodgy, say you're calling other offices.

Keep responses 2-3 sentences. Be direct and somewhat skeptical in tone.`,
                
                creepy: `You are calling a chiropractic office and will become inappropriate.

YOUR FIRST MESSAGE must be normal: "Hi, I'd like to schedule an appointment."

Start by answering their questions normally (1-2 exchanges). Then gradually become uncomfortable:
- Ask personal questions about the staff member
- Make slightly suggestive comments  
- Ask what they look like or personal details

DO NOT be explicitly vulgar. Keep it uncomfortable but not extreme.

The goal is to test if staff recognizes inappropriate behavior and ends the call professionally.

Keep responses brief - 1-2 sentences.`
            };

            const playAudioFromText = async (text) => {
                try {
                    setCurrentStatus('speaking');
                    setStatusText('Patient is speaking...');
                    shouldListenRef.current = false;
                    
                    // STOP speech recognition while AI speaks
                    if (recognitionRef.current) {
                        try {
                            recognitionRef.current.stop();
                        } catch (e) {
                            console.log('Recognition already stopped');
                        }
                    }

                    const response = await fetch('https://api.openai.com/v1/audio/speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'tts-1',
                            voice: 'nova',
                            input: text,
                            speed: 1.0
                        })
                    });

                    if (!response.ok) {
                        throw new Error('TTS API call failed');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    currentAudioRef.current = audio;

                    audio.onended = () => {
                        setCurrentStatus('listening');
                        setStatusText('Your turn - Speak now...');
                        URL.revokeObjectURL(audioUrl);
                        
                        // RESTART speech recognition after AI finishes
                        shouldListenRef.current = true;
                        setTimeout(() => {
                            try {
                                recognitionRef.current.start();
                            } catch (e) {
                                console.log('Recognition restart failed:', e);
                            }
                        }, 500);
                    };

                    await audio.play();
                } catch (error) {
                    console.error('Error playing audio:', error);
                    setCurrentStatus('listening');
                    setStatusText('Error - but you can continue speaking');
                    shouldListenRef.current = true;
                    
                    // Restart recognition on error
                    setTimeout(() => {
                        try {
                            recognitionRef.current.start();
                        } catch (e) {
                            console.log('Recognition restart failed:', e);
                        }
                    }, 500);
                }
            };

            const callOpenAI = async (messages) => {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: messages,
                            max_tokens: 150,
                            temperature: 0.8
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'API call failed');
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('Error calling OpenAI:', error);
                    throw error;
                }
            };

            const startCall = async () => {
                if (!apiKey.trim()) {
                    alert('Please enter your OpenAI API key first!');
                    return;
                }
                
                if (!difficulty) {
                    alert('Please select a difficulty level!');
                    return;
                }

                // Only check microphone permission once at start - don't re-request
                // The recognition will use existing permission

                setGameState('playing');
                setCurrentStatus('listening');
                setStatusText('Answer the phone - Greet the caller...');
                shouldListenRef.current = true;

                const initialMessage = {
                    role: 'system',
                    content: `${difficultyPrompts[difficulty]}

CRITICAL OPENING: The staff member will greet you first. After they greet you, your FIRST response MUST be a request to schedule an appointment. Say something like:
- "Yes, I would like to schedule an appointment"
- "I'm calling to book an appointment" 
- "I need to schedule an appointment for [your pain issue]"

YOU DO NOT ALREADY HAVE AN APPOINTMENT. You are calling to MAKE one.

NEVER say things like "Looking forward to my appointment" or "Excited for my visit" - you don't have one yet!

After requesting to schedule, respond naturally to their questions. Keep EVERY response very brief - maximum 2 sentences.`
                };

                setConversationHistory([initialMessage]);
                setMessages([{
                    type: 'system',
                    text: 'üìû Call connected - Greet the patient!'
                }]);

                try {
                    recognitionRef.current.start();
                } catch (e) {
                    console.log('Recognition already started or permission needed');
                    // If this fails, browser will prompt for permission automatically
                }
            };

            const handleStaffResponse = async (transcript) => {
                if (!transcript.trim() || isProcessingRef.current) return;

                isProcessingRef.current = true;
                shouldListenRef.current = false;
                
                // STOP listening while processing
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch (e) {
                        console.log('Recognition already stopped');
                    }
                }
                
                // Clear silence timer
                if (silenceTimerRef.current) {
                    clearTimeout(silenceTimerRef.current);
                }

                setMessages(prev => [...prev, { type: 'staff', text: transcript }]);
                setCurrentStatus('thinking');
                setStatusText('Patient is thinking...');

                try {
                    const newHistory = [
                        ...conversationHistory,
                        { role: 'user', content: `Staff member says: "${transcript}"\n\nRespond naturally as the patient. Keep it VERY brief - maximum 2 sentences. Be conversational.` }
                    ];

                    const patientResponse = await callOpenAI(newHistory);

                    setMessages(prev => [...prev, { type: 'patient', text: patientResponse }]);
                    setConversationHistory([
                        ...newHistory,
                        { role: 'assistant', content: patientResponse }
                    ]);

                    // Check if call is ending naturally
                    const lowerResponse = patientResponse.toLowerCase();
                    const callEndPhrases = ['see you then', 'thank you', 'sounds good', 'great thanks', 'talk to you later', 'bye', 'goodbye'];
                    const isEndingCall = callEndPhrases.some(phrase => lowerResponse.includes(phrase));
                    
                    if (isEndingCall && (lowerResponse.includes('appointment') || staffMessage.toLowerCase().includes('scheduled') || staffMessage.toLowerCase().includes('see you'))) {
                        // Call is naturally ending - stop listening
                        shouldListenRef.current = false;
                        if (recognitionRef.current) {
                            try {
                                recognitionRef.current.stop();
                            } catch (e) {}
                        }
                        
                        setTimeout(() => {
                            setMessages(prev => [...prev, { 
                                type: 'system', 
                                text: '‚úÖ Call completed - Patient booked and ended call naturally. Click "End Call & Get Score" to see your results.' 
                            }]);
                            setCurrentStatus('idle');
                            setStatusText('Call ended - Click "End Call & Get Score"');
                        }, 1000);
                        
                        return; // Don't play audio or continue
                    }

                    await playAudioFromText(patientResponse);
                } catch (error) {
                    console.error('Full error:', error);
                    setMessages(prev => [...prev, { 
                        type: 'system', 
                        text: `‚ùå Error: ${error.message}` 
                    }]);
                    setCurrentStatus('listening');
                    setStatusText('Error - but you can continue');
                    shouldListenRef.current = true;
                    
                    // Restart recognition on error
                    setTimeout(() => {
                        try {
                            recognitionRef.current.start();
                        } catch (e) {
                            console.log('Recognition restart failed:', e);
                        }
                    }, 500);
                }

                isProcessingRef.current = false;
            };

            const endCall = async () => {
                shouldListenRef.current = false;
                
                if (silenceTimerRef.current) {
                    clearTimeout(silenceTimerRef.current);
                }
                
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch (e) {}
                }

                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                }
                
                setCurrentStatus('thinking');
                setStatusText('Analyzing your performance...');
                
                try {
                    const conversationText = messages
                        .filter(m => m.type !== 'system')
                        .map(m => `${m.type === 'patient' ? 'PATIENT' : 'STAFF'}: ${m.text}`)
                        .join('\n\n');

                    if (difficulty === 'creepy') {
                        const creepyScoringPrompt = `You are evaluating how a chiropractic office staff member handled an inappropriate caller.

Here is the conversation:

${conversationText}

Evaluate if the staff member:
1. RECOGNIZED the inappropriate behavior
2. ENDED THE CALL professionally and promptly
3. Remained professional throughout

This is PASS/FAIL:
- PASS: Staff recognized inappropriate behavior and ended call professionally within 1-2 responses
- FAIL: Staff engaged with inappropriate content or did not end the call

Provide your evaluation in this EXACT JSON format (no other text):
{
  "result": "<PASS or FAIL>",
  "feedback": "<Detailed explanation>",
  "key_action": "<What they should have done or did well>"
}`;

                        const scoreResponse = await callOpenAI([{
                            role: 'user',
                            content: creepyScoringPrompt
                        }]);

                        const cleanedResponse = scoreResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                        const scoreJson = JSON.parse(cleanedResponse);
                        scoreJson.isCreepyCall = true;
                        setScoreData(scoreJson);
                        setGameState('scoring');
                    } else {
                        // PRE-ANALYSIS: Check for referral question manually
                        const lowerConvo = conversationText.toLowerCase();
                        const hasReferralQuestion = 
                            lowerConvo.includes('how did you hear') ||
                            lowerConvo.includes('how you hear') ||
                            lowerConvo.includes('who referred') ||
                            lowerConvo.includes('how did you find') ||
                            lowerConvo.includes('where did you hear') ||
                            lowerConvo.includes('how you find') ||
                            (lowerConvo.includes('staff') && (lowerConvo.includes('referred by') || lowerConvo.includes('friend referred') || lowerConvo.includes('google') || lowerConvo.includes('facebook')));
                        
                        const scoringPrompt = `You are a STRICT evaluator. You must analyze this SPECIFIC conversation and give ACCURATE scores.

CONVERSATION TO ANALYZE:
${conversationText}

CRITICAL: Do NOT give generic or example scores. Analyze what ACTUALLY happened above.

Check each step carefully. If a step was NOT done, give it 0 points. Be STRICT.

SCORING CHECKLIST:

1. GREETING (0-10 pts): Did staff say their NAME + OFFICE NAME + offer help?
   - Look for: "This is [name] from [office]" or similar
   - Give 10 if complete, 5 if partial, 0 if missing

2. SCHEDULING (0-15 pts): Did staff ask WHEN + narrow down time preferences?
   - Look for: "When can you come in? Morning or afternoon?"
   - Give 15 if both, 10 if only asked when, 0 if didn't ask

3. PATIENT NAME (0-10 pts): Did staff ask for name?
   - Look for: "What's your name?" or "May I have your name?"
   - Give 10 if asked, 0 if not

4. REFERRAL SOURCE (0-5 pts): Did staff ask how they found the office?
   - Look for: "How did you hear about us?" "Who referred you?" "How did you find us?"
   - If PATIENT mentions "friend" or "Google", that means staff ASKED (not shown in conversation)
   - Give 5 if ANY evidence they asked, 0 if clearly never discussed

5. PHONE NUMBER (0-5 pts): Did staff ask for phone/contact number?
   - Look for: "Phone number?" "Best number to reach you?"
   - Give 5 if asked, 0 if not

6. FEE EXPLANATION (0-20 pts): Did staff mention COST + WHAT TO BRING?
   - Must mention: dollar amount AND (ID/insurance OR what's included)
   - Give 20 if both, 15 if only cost, 0 if never mentioned

7. EMAIL (0-5 pts): Did staff ask for email?
   - Look for: "Email address?" "Where can I send paperwork?"
   - Give 5 if asked, 0 if not

BONUS (30 pts total):
- Health concerns asked: 0-5
- Family question: 0-5  
- Objection handling: 0-10
- Confirmed appointment: 0-5
- Professional tone: 0-5

IMPORTANT: Your scores MUST reflect what actually happened. Do NOT give example scores.

Return ONLY valid JSON (no markdown, no extra text):

{
  "critical_steps": {
    "greeting": {"score": <ACTUAL SCORE 0-10>, "completed": <true/false>, "feedback": "<what they actually said or 'Not completed'>"},
    "scheduling": {"score": <ACTUAL SCORE 0-15>, "completed": <true/false>, "feedback": "<actual quote or 'Not completed'>"},
    "name": {"score": <ACTUAL SCORE 0 or 10>, "completed": <true/false>, "feedback": "<actual or 'Not completed'>"},
    "referral": {"score": <ACTUAL SCORE 0 or 5>, "completed": <true/false>, "feedback": "<actual or 'Not completed'>"},
    "phone": {"score": <ACTUAL SCORE 0 or 5>, "completed": <true/false>, "feedback": "<actual or 'Not completed'>"},
    "fee_explanation": {"score": <ACTUAL SCORE 0-20>, "completed": <true/false>, "feedback": "<actual or 'Not completed'>"},
    "email": {"score": <ACTUAL SCORE 0 or 5>, "completed": <true/false>, "feedback": "<actual or 'Not completed'>"}
  },
  "bonus_steps": {
    "health_concerns": {"score": <0-5>, "completed": <true/false>},
    "family_upsell": {"score": <0-5>, "completed": <true/false>},
    "objection_handling": {"score": <0-10>, "completed": <true/false>},
    "confirmation": {"score": <0-5>, "completed": <true/false>},
    "professionalism": {"score": <0-5>, "completed": <true/false>}
  },
  "critical_total": <SUM OF CRITICAL SCORES>,
  "bonus_total": <SUM OF BONUS SCORES>,
  "total_score": <CRITICAL + BONUS>,
  "passed": <true if critical_total >= 56, false otherwise>,
  "summary": "<1 sentence about actual performance>"
}`;

                        const scoreResponse = await callOpenAI([{
                            role: 'user',
                            content: scoringPrompt
                        }]);

                        let scoreJson;
                        try {
                            let cleanedResponse = scoreResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                            
                            // Extract just the JSON object
                            const firstBrace = cleanedResponse.indexOf('{');
                            const lastBrace = cleanedResponse.lastIndexOf('}');
                            if (firstBrace !== -1 && lastBrace !== -1) {
                                cleanedResponse = cleanedResponse.substring(firstBrace, lastBrace + 1);
                            }
                            
                            // Remove control characters
                            cleanedResponse = cleanedResponse.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                            
                            scoreJson = JSON.parse(cleanedResponse);
                        } catch (e) {
                            console.error('JSON parse error:', e);
                            console.error('Response was:', scoreResponse);
                            
                            // Fallback with new structure
                            scoreJson = {
                                critical_steps: {
                                    greeting: {score: 8, completed: true, feedback: "Greeted professionally"},
                                    scheduling: {score: 12, completed: true, feedback: "Asked about timing"},
                                    name: {score: 10, completed: true, feedback: "Got patient name"},
                                    referral: {score: 0, completed: false, feedback: "Did not ask referral source"},
                                    phone: {score: 5, completed: true, feedback: "Got phone number"},
                                    fee_explanation: {score: 15, completed: true, feedback: "Mentioned fees"},
                                    email: {score: 5, completed: true, feedback: "Got email"}
                                },
                                bonus_steps: {
                                    health_concerns: {score: 5, completed: true},
                                    family_upsell: {score: 0, completed: false},
                                    objection_handling: {score: 8, completed: true},
                                    confirmation: {score: 4, completed: true},
                                    professionalism: {score: 4, completed: true}
                                },
                                critical_total: 55,
                                bonus_total: 21,
                                total_score: 76,
                                passed: false,
                                summary: "System had trouble analyzing but call was recorded."
                            };
                        }
                        
                        setScoreData(scoreJson);
                        setGameState('scoring');
                    }
                } catch (error) {
                    alert('Error generating score: ' + error.message);
                    setGameState('setup');
                }
            };

            const resetGame = () => {
                shouldListenRef.current = false;
                
                if (silenceTimerRef.current) {
                    clearTimeout(silenceTimerRef.current);
                }
                
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.stop();
                    } catch (e) {}
                }
                
                if (currentAudioRef.current) {
                    currentAudioRef.current.pause();
                }
                
                lastTranscriptRef.current = '';
                setGameState('setup');
                setDifficulty('');
                setMessages([]);
                setConversationHistory([]);
                setScoreData(null);
                setCurrentStatus('idle');
                setStatusText('');
                setInterimTranscript('');
            };

            // Password protection screen - shows first before anything else
            if (!isAuthenticated) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üîê Chiro Voice Training</h1>
                            <p>Authorized Access Only</p>
                        </div>
                        <div className="content">
                            <div style={{textAlign: 'center', padding: '60px 20px'}}>
                                <h2 style={{marginBottom: '20px', color: '#333'}}>Welcome</h2>
                                <p style={{marginBottom: '30px', fontSize: '16px', color: '#666'}}>
                                    Please enter your access password to continue.
                                </p>
                                <div style={{maxWidth: '400px', margin: '0 auto'}}>
                                    <input 
                                        type="password"
                                        placeholder="Enter password"
                                        value={passwordAttempt}
                                        onChange={(e) => setPasswordAttempt(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                checkPassword();
                                            }
                                        }}
                                        style={{
                                            width: '100%',
                                            padding: '15px',
                                            fontSize: '16px',
                                            border: passwordError ? '2px solid #f44336' : '2px solid #667eea',
                                            borderRadius: '10px',
                                            marginBottom: '15px'
                                        }}
                                        autoFocus
                                    />
                                    {passwordError && (
                                        <p style={{color: '#f44336', marginBottom: '15px', fontSize: '14px'}}>
                                            {passwordError}
                                        </p>
                                    )}
                                    <button 
                                        className="start-btn"
                                        onClick={checkPassword}
                                    >
                                        Access App
                                    </button>
                                    <p style={{marginTop: '30px', fontSize: '14px', color: '#999'}}>
                                        Don't have access? Contact the administrator.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (showApiKeyPrompt) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üé§ Chiro Voice Training</h1>
                            <p>Professional patient call simulator</p>
                        </div>
                        <div className="content">
                            <div style={{textAlign: 'center', padding: '40px 20px'}}>
                                <h2 style={{marginBottom: '20px', color: '#333'}}>Welcome! üëã</h2>
                                <p style={{marginBottom: '30px', fontSize: '16px', color: '#666'}}>
                                    To get started, please enter your OpenAI API key below.
                                    <br/>This will be saved in your browser for future use.
                                </p>
                                <div style={{maxWidth: '500px', margin: '0 auto'}}>
                                    <input 
                                        type="password"
                                        placeholder="sk-proj-..."
                                        style={{
                                            width: '100%',
                                            padding: '15px',
                                            fontSize: '16px',
                                            border: '2px solid #667eea',
                                            borderRadius: '10px',
                                            marginBottom: '20px',
                                            fontFamily: 'monospace'
                                        }}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter' && e.target.value.trim()) {
                                                saveApiKey(e.target.value.trim());
                                            }
                                        }}
                                        id="apiKeyInput"
                                    />
                                    <button 
                                        className="start-btn"
                                        onClick={() => {
                                            const input = document.getElementById('apiKeyInput');
                                            if (input.value.trim()) {
                                                saveApiKey(input.value.trim());
                                            } else {
                                                alert('Please enter your API key');
                                            }
                                        }}
                                    >
                                        Save & Continue
                                    </button>
                                    <p style={{marginTop: '20px', fontSize: '14px', color: '#666'}}>
                                        Don't have an API key? <br/>
                                        Get one at <a href="https://platform.openai.com/api-keys" target="_blank" style={{color: '#667eea'}}>platform.openai.com/api-keys</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'setup') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üé§ Chiro Voice Training</h1>
                            <p>Answer the phone and practice your skills!</p>
                            {!OPENAI_API_KEY && (
                                <p style={{background: '#fff3cd', padding: '10px', borderRadius: '8px', marginTop: '15px', color: '#856404'}}>
                                    ‚ö†Ô∏è Remember to add your API key on line 232 of the code!
                                </p>
                            )}
                        </div>
                        <div className="content">
                            <div className="setup-screen">
                                <div className="instructions">
                                    <h3>üì± How This Works:</h3>
                                    <ul>
                                        <li><strong>Click "Start Call"</strong> - The phone rings!</li>
                                        <li><strong>YOU greet first</strong> - Answer like: "Hello, this is [your name] from Next Medical Florida, how can I help?"</li>
                                        <li><strong>Patient responds</strong> with voice</li>
                                        <li><strong>Just talk naturally</strong> - No buttons during the call!</li>
                                        <li><strong>Pause briefly</strong> when done speaking (system waits for silence)</li>
                                        <li><strong>Click "End Call"</strong> when finished to get your score</li>
                                    </ul>
                                </div>
                                
                                <h2 style={{marginTop: '30px', marginBottom: '20px', color: '#333'}}>Select Difficulty Level:</h2>
                                <div className="difficulty-selector">
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'easy' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('easy')}
                                    >
                                        üòä Easy<br/>
                                        <small>Quick booker</small>
                                    </button>
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'challenging' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('challenging')}
                                    >
                                        ü§î Challenging<br/>
                                        <small>Price conscious</small>
                                    </button>
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'difficult' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('difficult')}
                                    >
                                        üò§ Difficult<br/>
                                        <small>Skeptical shopper</small>
                                    </button>
                                    <button 
                                        className={`difficulty-btn ${difficulty === 'creepy' ? 'selected' : ''}`}
                                        onClick={() => setDifficulty('creepy')}
                                        style={{borderColor: '#dc3545'}}
                                    >
                                        üö® Creepy Caller<br/>
                                        <small>Inappropriate behavior</small>
                                    </button>
                                </div>
                                <button 
                                    className="start-btn"
                                    onClick={startCall}
                                    disabled={!difficulty}
                                >
                                    üìû Start Call
                                </button>
                                <p style={{marginTop: '15px', color: '#666', fontSize: '14px'}}>
                                    üé§ Allow microphone when prompted
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'playing') {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìû Live Training Call</h1>
                            <p>Difficulty: {difficulty.toUpperCase()}</p>
                        </div>
                        <div className="content">
                            <div className="call-screen">
                                <div className="call-status">
                                    {currentStatus === 'listening' && 'üé§'}
                                    {currentStatus === 'speaking' && 'üîä'}
                                    {currentStatus === 'thinking' && 'üí≠'}
                                </div>
                                
                                <div className="status-text">
                                    {currentStatus === 'listening' && (
                                        <><span className="pulse-indicator listening"></span>{statusText}</>
                                    )}
                                    {currentStatus === 'speaking' && (
                                        <><span className="pulse-indicator speaking"></span>{statusText}</>
                                    )}
                                    {currentStatus === 'thinking' && (
                                        <><span className="pulse-indicator thinking"></span>{statusText}</>
                                    )}
                                </div>

                                {interimTranscript && (
                                    <div className="transcript-preview">
                                        Hearing: "{interimTranscript}"
                                    </div>
                                )}

                                <div className="chat-container">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`message ${msg.type}`}>
                                            {msg.text}
                                        </div>
                                    ))}
                                    <div ref={chatEndRef} />
                                </div>

                                <button className="end-call-btn" onClick={endCall}>
                                    ‚èπÔ∏è End Call & Get Score
                                </button>

                                <div style={{marginTop: '20px', padding: '15px', background: '#f5f5f5', borderRadius: '8px', fontSize: '14px', color: '#666'}}>
                                    üí° <strong>Tip:</strong> Speak clearly and pause for 1.5-2 seconds when you're done talking. The system waits for silence before the patient responds.
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'scoring') {
                if (scoreData.isCreepyCall) {
                    return (
                        <div className="container">
                            <div className="header">
                                <h1>üö® Inappropriate Caller Handling</h1>
                                <p>Pass/Fail Evaluation</p>
                            </div>
                            <div className="content">
                                <div className="score-card">
                                    <div className="overall-score" style={{
                                        color: scoreData.result === 'PASS' ? '#4caf50' : '#f44336'
                                    }}>
                                        {scoreData.result}
                                    </div>
                                    
                                    <div className="score-item">
                                        <h3>üìã What Happened:</h3>
                                        <p>{scoreData.feedback}</p>
                                    </div>
                                    
                                    <div className="score-item">
                                        <h3>üí° Key Action:</h3>
                                        <p>{scoreData.key_action}</p>
                                    </div>
                                    
                                    <div className="score-item" style={{marginTop: '30px', background: 'rgba(255,255,255,0.3)'}}>
                                        <h3>‚úÖ Best Practice:</h3>
                                        <p>When a caller becomes inappropriate, remain professional and end the call immediately:</p>
                                        <p style={{marginTop: '10px', fontStyle: 'italic'}}>
                                            "I'm going to end this call now. Have a good day." <br/>
                                            "This conversation is not appropriate. Goodbye."
                                        </p>
                                    </div>
                                </div>
                                
                                <button 
                                    className="start-btn"
                                    onClick={resetGame}
                                    style={{marginTop: '20px'}}
                                >
                                    Try Another Call
                                </button>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="container">
                        <div className="header">
                            <h1>üìä Performance Review</h1>
                            <p>{scoreData.passed ? '‚úÖ PASSED' : '‚ùå NEEDS IMPROVEMENT'}</p>
                        </div>
                        <div className="content">
                            <div className="score-card">
                                <div className="overall-score" style={{
                                    color: scoreData.passed ? '#4caf50' : '#f44336'
                                }}>
                                    {scoreData.total_score}/100
                                </div>
                                
                                <h2 style={{marginBottom: '25px'}}>Critical Steps (70 pts required):</h2>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.greeting.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.greeting.completed ? '‚úÖ' : '‚ùå'} Professional Greeting with Office Name: {scoreData.critical_steps.greeting.score}/10</h3>
                                    <p>{scoreData.critical_steps.greeting.feedback}</p>
                                    {!scoreData.critical_steps.greeting.completed && (
                                        <p style={{marginTop: '8px', fontStyle: 'italic', opacity: 0.9}}>
                                            üí° Should include: Your name, office/clinic name, and "how can I help?"
                                        </p>
                                    )}
                                </div>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.scheduling.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.scheduling.completed ? '‚úÖ' : '‚ùå'} Scheduling Questions: {scoreData.critical_steps.scheduling.score}/15</h3>
                                    <p>{scoreData.critical_steps.scheduling.feedback}</p>
                                </div>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.name.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.name.completed ? '‚úÖ' : '‚ùå'} Get Patient Name: {scoreData.critical_steps.name.score}/10</h3>
                                    <p>{scoreData.critical_steps.name.feedback}</p>
                                </div>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.referral.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.referral.completed ? '‚úÖ' : '‚ùå'} Ask How They Heard About Us: {scoreData.critical_steps.referral.score}/5</h3>
                                    <p>{scoreData.critical_steps.referral.feedback}</p>
                                    {!scoreData.critical_steps.referral.completed && (
                                        <p style={{marginTop: '8px', fontStyle: 'italic', opacity: 0.9}}>
                                            üí° Should ask: "How did you hear about us?" or "Who referred you?"
                                        </p>
                                    )}
                                </div>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.phone.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.phone.completed ? '‚úÖ' : '‚ùå'} Get Phone Number: {scoreData.critical_steps.phone.score}/5</h3>
                                    <p>{scoreData.critical_steps.phone.feedback}</p>
                                    {!scoreData.critical_steps.phone.completed && (
                                        <p style={{marginTop: '8px', fontStyle: 'italic', opacity: 0.9}}>
                                            üí° Should ask: "What's the best number to reach you?"
                                        </p>
                                    )}
                                </div>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.fee_explanation.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.fee_explanation.completed ? '‚úÖ' : '‚ùå'} Explain First Visit Fee & What's Included: {scoreData.critical_steps.fee_explanation.score}/20</h3>
                                    <p>{scoreData.critical_steps.fee_explanation.feedback}</p>
                                    {!scoreData.critical_steps.fee_explanation.completed && (
                                        <p style={{marginTop: '8px', fontStyle: 'italic', opacity: 0.9}}>
                                            üí° Must mention: Cost amount AND what's included or what to bring (ID, insurance, etc.)
                                        </p>
                                    )}
                                </div>
                                
                                <div className="score-item" style={{
                                    background: scoreData.critical_steps.email.completed ? 'rgba(76,175,80,0.3)' : 'rgba(244,67,54,0.3)'
                                }}>
                                    <h3>{scoreData.critical_steps.email.completed ? '‚úÖ' : '‚ùå'} Get Email Address: {scoreData.critical_steps.email.score}/5</h3>
                                    <p>{scoreData.critical_steps.email.feedback}</p>
                                    {!scoreData.critical_steps.email.completed && (
                                        <p style={{marginTop: '8px', fontStyle: 'italic', opacity: 0.9}}>
                                            üí° Should ask: "May I have your email to send paperwork?"
                                        </p>
                                    )}
                                </div>
                                
                                <div style={{margin: '30px 0', padding: '20px', background: 'rgba(255,255,255,0.3)', borderRadius: '10px'}}>
                                    <h3>Critical Steps Total: {scoreData.critical_total}/70</h3>
                                    <h3 style={{marginTop: '10px'}}>Bonus Points: {scoreData.bonus_total}/30</h3>
                                </div>
                                
                                <h2 style={{marginBottom: '15px'}}>Bonus Points:</h2>
                                
                                <div className="score-item">
                                    <h3>{scoreData.bonus_steps.health_concerns.completed ? '‚úÖ' : '‚óã'} Asked About Health Concerns: {scoreData.bonus_steps.health_concerns.score}/5</h3>
                                </div>
                                
                                <div className="score-item">
                                    <h3>{scoreData.bonus_steps.family_upsell.completed ? '‚úÖ' : '‚óã'} Family Upsell Question: {scoreData.bonus_steps.family_upsell.score}/5</h3>
                                </div>
                                
                                <div className="score-item">
                                    <h3>{scoreData.bonus_steps.objection_handling.completed ? '‚úÖ' : '‚óã'} Objection Handling: {scoreData.bonus_steps.objection_handling.score}/10</h3>
                                </div>
                                
                                <div className="score-item">
                                    <h3>{scoreData.bonus_steps.confirmation.completed ? '‚úÖ' : '‚óã'} Final Confirmation: {scoreData.bonus_steps.confirmation.score}/5</h3>
                                </div>
                                
                                <div className="score-item">
                                    <h3>{scoreData.bonus_steps.professionalism.completed ? '‚úÖ' : '‚óã'} Professionalism/Enthusiasm: {scoreData.bonus_steps.professionalism.score}/5</h3>
                                </div>
                                
                                <div className="score-item" style={{marginTop: '30px', background: 'rgba(255,255,255,0.4)'}}>
                                    <h3>üìù Summary:</h3>
                                    <p style={{fontSize: '16px'}}>{scoreData.summary}</p>
                                </div>
                            </div>
                            
                            <button 
                                className="start-btn"
                                onClick={resetGame}
                                style={{marginTop: '20px'}}
                            >
                                Try Another Call
                            </button>
                        </div>
                    </div>
                );
            }
        }

        ReactDOM.render(<ChiroVoiceTrainer />, document.getElementById('root'));
    </script>
</body>
</html>
